"use strict";(function(){Bridge.define("TouchSample.TouchSample",{statics:{config:{init:function(){Bridge.ready(this.start)}},start:function(){(new TouchSample.TouchSample).initialize()}},canvas:null,context2D:null,config:{properties:{Log:null,OngoingTouches:null}},getCanvas:function(){return this.canvas},setCanvas:function(value){this.canvas=value;this.context2D=Bridge.hasValue(this.canvas)?this.canvas.getContext("2d"):null},getContext2D:function(){return this.context2D},logMessage:function(message,newLine){newLine===void 0&&(newLine=!0);this.getLog().innerHTML+=message+(newLine?"\n":"")},initialize:function(){this.setOngoingTouches(new Bridge.List$1(TouchSample.TouchShadow)());this.setCanvas(document.getElementById("canvas"));this.setLog(document.getElementById("log"));this.getCanvas().onclick=Bridge.fn.combine(this.getCanvas().onclick,Bridge.fn.bind(this,this.clickHandler));this.getCanvas().ontouchstart=Bridge.fn.combine(this.getCanvas().ontouchstart,Bridge.fn.bind(this,this.touchStartHandler));this.getCanvas().ontouchmove=Bridge.fn.combine(this.getCanvas().ontouchmove,Bridge.fn.bind(this,this.touchMoveHandler));this.getCanvas().ontouchend=Bridge.fn.combine(this.getCanvas().ontouchend,Bridge.fn.bind(this,this.touchEndHandler));this.getCanvas().ontouchcancel=Bridge.fn.combine(this.getCanvas().ontouchcancel,Bridge.fn.bind(this,this.touchCancelHandler));this.logMessage("Initialized.")},clickHandler:function(){this.logMessage("ClickHandler.")},touchStartHandler:function(evt){for(var t,color,ctx=this.getContext2D(),touches=evt.touches,i=0;i<touches.length;i++)this.logMessage("touchstart:"+i+"..."),t=touches[i],this.getOngoingTouches().add(this.copyTouch(t)),color=this.colorForTouch(t,t.identifier+" start idx "+(this.getOngoingTouches().getCount()-1)+" "),ctx.beginPath(),ctx.arc(t.pageX,t.pageY,4,0,2*Math.PI,!1),ctx.fillStyle=color,ctx.fill(),this.logMessage("touchstart:"+i+".")},touchMoveHandler:function(evt){var ctx,touches,i,t,idx,color,ogt;for(evt.preventDefault(),ctx=this.getContext2D(),touches=evt.changedTouches,i=0;i<touches.length;i++)t=touches[i],idx=this.ongoingTouchIndexById(t.identifier),idx>=0?(this.logMessage("continuing touch "+idx),color=this.colorForTouch(t,t.identifier+" move idx "+idx+" "),ctx.beginPath(),ogt=this.getOngoingTouches().getItem(idx),this.logMessage("ctx.moveTo("+ogt.getPageX()+", "+ogt.getPageY()+");"),ctx.moveTo(ogt.getPageX(),ogt.getPageY()),this.logMessage("ctx.lineTo("+t.pageX+", "+t.pageY+");"),ctx.lineTo(t.pageX,t.pageY),ctx.lineWidth=4,ctx.strokeStyle=color,ctx.stroke(),this.getOngoingTouches().setItem(idx,this.copyTouch(t)),this.logMessage("continued .")):this.logMessage("can't figure out which touch to continue")},touchEndHandler:function(evt){var ctx,touches,i,t,idx,color,ogt;for(evt.preventDefault(),this.logMessage("touchend"),ctx=this.getContext2D(),touches=evt.changedTouches,i=0;i<touches.length;i++)t=touches[i],idx=this.ongoingTouchIndexById(t.identifier),idx>=0?(color=this.colorForTouch(t,t.identifier+" end idx "+idx+" "),ctx.lineWidth=4,ctx.fillStyle=color,ctx.beginPath(),ogt=this.getOngoingTouches().getItem(idx),ctx.moveTo(ogt.getPageX(),ogt.getPageY()),ctx.lineTo(t.pageX,t.pageY),ctx.fillRect(t.pageX-4,t.pageY-4,8,8),this.getOngoingTouches().removeAt(idx)):this.logMessage("can't figure out which touch to end")},touchCancelHandler:function(evt){evt.preventDefault();this.getOngoingTouches().clear();this.logMessage("touchcancel.")},copyTouch:function(source){return Bridge.merge(new TouchSample.TouchShadow,{setIdentifier:source.identifier,setPageX:source.pageX,setPageY:source.pageY})},colorForTouch:function(touch,who){var r=touch.identifier%16,g=Math.floor(Bridge.cast(Bridge.Int.div(touch.identifier,3),Number))%16,b=Math.floor(Bridge.cast(Bridge.Int.div(touch.identifier,7),Number))%16,rx=Bridge.Int.format(r,"X"),gx=Bridge.Int.format(g,"X"),bx=Bridge.Int.format(b,"X"),color="#"+rx+gx+bx;return this.logMessage(who+" color for touch with identifier "+touch.identifier+" = "+color),color},ongoingTouchIndexById:function(id){for(var i=0;i<this.getOngoingTouches().getCount();i++)if(this.getOngoingTouches().getItem(i).getIdentifier()===id)return i;return-1}});Bridge.define("TouchSample.TouchShadow",{config:{properties:{Identifier:0,PageX:0,PageY:0}}});Bridge.init()})(this);